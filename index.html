<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="nl" lang="nl">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<title>Kingsquare JavaScript C64 emulator</title>
	<link rel="stylesheet" type="text/css" href="css/jsc64.css" media="screen, projection" />

</head>
<body>
	<fieldset id="controls">
		<h2>Click on one ROM to load&amp;launch it</h2>
		<ul id="romList">
			<li><a href="rom/SIDE PACMAN.PRG">SIDE PAcMAN by MR.Z</a> (<a href="https://github.com/jumpjack/ChoplifterReverseWithAI/tree/main/others">disassembly experiment</a>)</li>
			<li><a href="rom/GALAGA.PRG">GALAGA</a></li>
			<li><a href="rom/COLOURGALAGA.PRG">GALAGACOLOR</a></li>
			<li><a href="rom/HELLGATE.PRG">HELLGATE</a></li>
			<li><a href="rom/MATRIX.PRG">MATRIX</a></li>
			<li><a href="rom/RALLYSPEEDWAYII.PRG">RALLYSPEEDWAYII</a></li>
			<li><a href="rom/VOIDRUNNER.PRG">VOIDRUNNER</a></li>
		</ul>
		<h2>Controls</h2>
		<input type="button" id="pauseButton" value="Pause" />
		<input type="button" id="debugButton" value="Debug" />
		<input type="button" id="RAMbutton" value="RAM" />
		<input type="button" id="toggleUpdate" value="Start RAM update" />
 		
		You may want to use input below to 'focus' your cursor.
		<input type="text" id="focusButton" value=""/><br>
		Open console to access emulator functions.<br>		
	</fieldset>
	<div id="container"></div>
	<div id="loadingProgress">Booting: <span class="progress">0</span>% complete</div>
	<div id="ram">   <canvas id="memoryCanvas" width="256" height="256"></canvas></div></div>
	
 

	<script type="text/javascript" src="js/jquery/jquery-1.12.4.min.js"></script>
	<script type="text/javascript" src="js/jquery.jsc64classes.js"></script>
	<script type="text/javascript" src="js/jquery.jsc64.js"></script>

	
	<script type="text/javascript">
		// <![CDATA[
		//var jsc64; // let's make it available in console...
		$(document).ready(function() {
			var jsc64 = $('#container').jsc64($(document)), jsc64Instance = jsc64.jsc64GetInstance(),  percentageComplete = 0, bootWaitFunction;
			bootWaitFunction = function() {				
				$('#loadingProgress .progress').text(percentageComplete++);
				if (percentageComplete>100) {				
					$('#loadingProgress').hide('slow');
					$('#controls').show('slow');
					jsc64Instance._renderer.frameTimer.detachEvent('timer', bootWaitFunction);
				}
			}
			jsc64Instance._renderer.frameTimer.addEventListener('timer', bootWaitFunction);
////////////////////////////////////////////
         updateInterval = 100;
	 pixelSize = 4;			
         isUpdating = false;
         updateTimer = null;
	myC64 = null;
        const toggleUpdateButton = document.getElementById('toggleUpdate');
        toggleUpdateButton.addEventListener('click', startUpdate);
			
			
			$('#pauseButton').click(function() {
				jsc64.jsc64Pause();
			});
			
			$('#debugButton').click(function() {
				console.log("JSC64:", jsc64);
				
				myC64 = jsc64.jsc64GetInstance();			
				console.log("Use this object to access functions:", myC64);
				
				myMemObj = myC64._mem;
				console.log("Use this object to access memory functions and data:", myMemObj);
				mem64kUint8 = new Uint8Array(myMemObj.ram);
				console.log("Whole RAM is in mem64kUint8",mem64kUint8, ", use showMemory(mem64kUint8,pixelSize) to display it");
			});
			
			$('#RAMbutton').click(function() {
				showMemory(mem64kUint8,2);
			});
			
			$('#romList a').click(function() {
			  	jsc64.loadPrg($(this).attr('href'));
			  	return false;
			});
        const canvas = document.getElementById('memoryCanvas');
        const ctx = canvas.getContext('2d');

        function showMemory(memory,pixelSize) {
	   // accepts jsc64._mem.ram
            const width = 256 * pixelSize;
            const height = 256 * pixelSize;
            canvas.width = width;
            canvas.height = height;
            
            const imageData = ctx.createImageData(width, height);
            for (let y = 0; y < 256; y++) {
                for (let x = 0; x < 256; x++) {
                    const value = memory[y * 256 + x];
                    for (let py = 0; py < pixelSize; py++) {
                        for (let px = 0; px < pixelSize; px++) {
                            const index = ((y * pixelSize + py) * width + (x * pixelSize + px)) * 4;
                            imageData.data[index] = value;     // R
                            imageData.data[index + 1] = value; // G
                            imageData.data[index + 2] = value; // B
                            imageData.data[index + 3] = 255;   // A
                        }
                    }
                }
            }
            ctx.putImageData(imageData, 0, 0);
        }	

       function startUpdate() {
console.log("startUpdate?");	       
            if (!isUpdating) {
console.log("start");		    
                isUpdating = true;
                updateTimer = setInterval(updateMemoryAndVisualize, updateInterval);
                toggleUpdateButton.textContent = 'Stop Update';
            } else {
console.log("stop");		    
                isUpdating = false;
                clearInterval(updateTimer);
                toggleUpdateButton.textContent = 'Start Update';
            }
        }		

        function updateMemoryAndVisualize() {
console.log("udating every ", updateInterval);		    
		mem64kUint8 = new Uint8Array(myC64._mem.ram);
            	showMemory(mem64kUint8,2);
        }			
		});
		// ]]>
	</script>
</body>
</html>
